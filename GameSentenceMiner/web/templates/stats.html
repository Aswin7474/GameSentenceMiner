<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSM Dashboard</title>
    <!-- Include Chart.js from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #343a40;
        }
        .chart-container {
            position: relative;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .heatmap-year {
            margin-bottom: 30px;
        }
        .heatmap-year h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 12px);
            gap: 2px;
            max-width: 700px;
        }
        .heatmap-cell {
            width: 12px;
            height: 12px;
            background-color: #ebedf0;
            border-radius: 2px;
            position: relative;
        }
        .heatmap-cell.level-1 { background-color: #c6e48b; }
        .heatmap-cell.level-2 { background-color: #7bc96f; }
        .heatmap-cell.level-3 { background-color: #239a3b; }
        .heatmap-cell.level-4 { background-color: #196127; }
        .heatmap-legend {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
            color: #586069;
        }
        .heatmap-legend-item {
            width: 12px;
            height: 12px;
            margin: 0 2px;
            border-radius: 2px;
        }
        .streak-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
        }
        .streak-item {
            text-align: center;
        }
        .streak-number {
            font-size: 3em;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 5px;
        }
        .streak-label {
            font-size: 1.1em;
            color: #6c757d;
        }
        .streak-flame {
            text-align: center;
            font-size: 4em;
            margin-top: 10px;
        }
        .streak-flame.active {
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0% { transform: scale(1) rotate(-2deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Game Sentence Miner - Statistics</h1>

    <div class="chart-container">
        <h2>Lines Received Over Time</h2>
        <canvas id="linesChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Characters Read Over Time</h2>
        <canvas id="charsChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Mined Lines Over Time</h2>
        <canvas id="minedChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Reading Activity Heatmap</h2>
        <div id="heatmapContainer"></div>
    </div>

    <div class="chart-container">
        <h2>Reading Speed by Game (Chronological Order)</h2>
        <canvas id="readingSpeedChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Daily Reading Streak</h2>
        <div id="streakContainer">
            <div class="streak-stats">
                <div class="streak-item">
                    <div class="streak-number" id="currentStreak">0</div>
                    <div class="streak-label">Current Streak</div>
                </div>
                <div class="streak-item">
                    <div class="streak-number" id="longestStreak">0</div>
                    <div class="streak-label">Longest Streak</div>
                </div>
            </div>
            <div class="streak-flame" id="streakFlame">ðŸ”¥</div>
        </div>
    </div>

    <div class="chart-container">
        <h2>Mining Efficiency Over Time</h2>
        <canvas id="miningEfficiencyChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Most Common Characters</h2>
        <canvas id="characterFrequencyChart"></canvas>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // Helper function to create a chart to avoid repeating code
    function createChart(canvasId, datasets, chartTitle) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: datasets.labels,
                datasets: datasets.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: chartTitle
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cumulative Count'
                        }
                    },
                    x: {
                         title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    // Function to create heatmap
    function createHeatmap(heatmapData) {
        const container = document.getElementById('heatmapContainer');
        
        Object.keys(heatmapData).sort().forEach(year => {
            const yearData = heatmapData[year];
            const yearDiv = document.createElement('div');
            yearDiv.className = 'heatmap-year';
            
            const yearTitle = document.createElement('h3');
            yearTitle.textContent = year;
            yearDiv.appendChild(yearTitle);
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'heatmap-grid';
            
            // Create 365 cells for the year
            for (let day = 0; day < 365; day++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                
                const date = new Date(parseInt(year), 0, day + 1);
                const dateStr = date.toISOString().split('T')[0];
                
                if (yearData[dateStr]) {
                    const level = Math.min(4, Math.ceil(yearData[dateStr] / 1000)); // 1000 chars per level
                    cell.classList.add(`level-${level}`);
                    cell.title = `${dateStr}: ${yearData[dateStr]} characters`;
                } else {
                    cell.title = `${dateStr}: 0 characters`;
                }
                
                gridDiv.appendChild(cell);
            }
            
            yearDiv.appendChild(gridDiv);
            
            // Add legend
            const legend = document.createElement('div');
            legend.className = 'heatmap-legend';
            legend.innerHTML = `
                <span>Less</span>
                <div class="heatmap-legend-item" style="background-color: #ebedf0;"></div>
                <div class="heatmap-legend-item level-1"></div>
                <div class="heatmap-legend-item level-2"></div>
                <div class="heatmap-legend-item level-3"></div>
                <div class="heatmap-legend-item level-4"></div>
                <span>More</span>
            `;
            yearDiv.appendChild(legend);
            
            container.appendChild(yearDiv);
        });
    }

    // Function to create reading speed chart
    function createReadingSpeedChart(speedData) {
        const ctx = document.getElementById('readingSpeedChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: speedData.labels,
                datasets: [{
                    label: 'Reading Speed (chars/min)',
                    data: speedData.speeds,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Reading Speed by Game (Chronological Order)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Characters per Minute'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Games (Chronological Order)'
                        }
                    }
                }
            }
        });
    }

    // Function to display streak data
    function displayStreakData(streakData) {
        document.getElementById('currentStreak').textContent = streakData.currentStreak;
        document.getElementById('longestStreak').textContent = streakData.longestStreak;
        
        const flame = document.getElementById('streakFlame');
        if (streakData.currentStreak > 0) {
            flame.classList.add('active');
        } else {
            flame.classList.remove('active');
        }
    }

    // Function to create mining efficiency chart
    function createMiningEfficiencyChart(efficiencyData) {
        const ctx = document.getElementById('miningEfficiencyChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: efficiencyData.labels,
                datasets: [{
                    label: 'Mining Efficiency (%)',
                    data: efficiencyData.efficiency,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Mining Efficiency (Mined Lines / Total Lines)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Efficiency (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    // Function to create character frequency chart
    function createCharacterFrequencyChart(charData) {
        const ctx = document.getElementById('characterFrequencyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: charData.characters,
                datasets: [{
                    label: 'Frequency',
                    data: charData.frequencies,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Most Frequently Encountered Characters'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Frequency Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Characters'
                        }
                    }
                }
            }
        });
    }

    // Fetch data from our API endpoint
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.labels || data.labels.length === 0) {
                console.log("No data to display.");
                return;
            }

            // Filter datasets for each chart
            const linesData = {
                labels: data.labels,
                datasets: data.datasets.filter(d => d.label.includes('Lines Received'))
            };

            const charsData = {
                labels: data.labels,
                datasets: data.datasets.filter(d => d.label.includes('Characters Read'))
            };
            
            const minedData = {
                labels: data.labels,
                datasets: data.datasets.filter(d => d.label.includes('Lines Mined'))
            };

            // Remove the 'hidden' property so they appear on their own charts
            [...charsData.datasets, ...minedData.datasets].forEach(d => delete d.hidden);

            // Create the charts
            createChart('linesChart', linesData, 'Cumulative Lines Received');
            createChart('charsChart', charsData, 'Cumulative Characters Read');
            createChart('minedChart', minedData, 'Cumulative Mined Lines (with audio/screenshot)');

            // Create heatmap if data exists
            if (data.heatmapData) {
                createHeatmap(data.heatmapData);
            }

            // Create reading speed chart if data exists
            if (data.readingSpeedData) {
                createReadingSpeedChart(data.readingSpeedData);
            }

            // Create streak display if data exists
            if (data.streakData) {
                displayStreakData(data.streakData);
            }

            // Create mining efficiency chart if data exists
            if (data.miningEfficiencyData) {
                createMiningEfficiencyChart(data.miningEfficiencyData);
            }

            // Create character frequency chart if data exists
            if (data.characterFrequencyData) {
                createCharacterFrequencyChart(data.characterFrequencyData);
            }
        })
        .catch(error => console.error('Error fetching chart data:', error));
});
</script>

</body>
</html>
